# Copyright (c) 2020 Patrick Diehl
#               
#
# Distributed under the Boost Software License, Version 1.0. (See accompanying
# file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)

version: 2
jobs:
    build:
        docker:
          - image: diehlpk/nonlocalmodels:baseimage
        steps:
            - checkout
            - run:
                name: Configure 
                command: | 
                  mkdir -p build 
                  cd build 
                  cmake -DCMAKE_BUILD_TYPE=Release ..
            - run:
                name: Build
                command: |  
                  cd build 
                  make -j 2
            - run:
                name: Test
                command: |
                  cd build 
                  make test
    deploy:
      docker:
        - image: docker:17.05.0-ce-git
      steps:
        - setup_remote_docker
        - run: docker pull diehlpk/nonlocalmodels:baseimage
        - run: docker start $(docker inspect --format="{{.Id}}" diehlpk/nonlocalmodels:baseimage)
        - run: docker exec -it $(docker inspect --format="{{.Id}}" diehlpk/nonlocalmodels:baseimage) git clone https://github.com/nonlocalmodels/nonlocalheatequation.git |  cd nonlocalheatequation | mkdir -p build | cd build | cmake -DCMAKE_BUILD_TYPE=Release .. | make -j 2
        - run: docker tag $(docker inspect --format="{{.Id}}" diehlpk/nonlocalmodels:baseimage) diehlpk/nonlocalheatequation:latest
        - run: docker push diehlpk/nonlocalheatequation:latest
        - run: docker login -u $DOCKER_USER -p $DOCKER_PASS

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build
      - deploy
